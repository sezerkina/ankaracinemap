<!DOCTYPE html>

<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Ankara‚Äônƒ±n Sinematik Kartografyasƒ±</title>
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<!-- --- Robust removal of Leaflet credits & scale, and dynamic 1: scale display --- -->
<script>
  // This script references `map` variable later; it will attach handlers once map exists.
  (function(){
    function ensureHidden() {
      document.querySelectorAll('.leaflet-control-attribution, .leaflet-control-scale').forEach(el => { try{ el.remove(); }catch(e){} });
      const s = document.createElement('style');
      s.id = 'force-hide-leaflet-credits';
      s.innerHTML = '.leaflet-control-attribution, .leaflet-control-scale{display:none !important; visibility:hidden !important; height:0 !important; margin:0 !important; padding:0 !important;}';
      if(!document.getElementById('force-hide-leaflet-credits')) document.head.appendChild(s);
    }
    ensureHidden();
    setTimeout(ensureHidden, 250);
    setTimeout(ensureHidden, 800);
    window._ensureHiddenInterval = setInterval(ensureHidden, 1200);

    // Create/update scale when map is ready
    function setupScale(map){
      if(!map) return;
      if(window._ensureHiddenInterval) { clearInterval(window._ensureHiddenInterval); window._ensureHiddenInterval = null; }
      let scaleDiv = document.querySelector('.custom-scale');
      if(!scaleDiv){
        scaleDiv = L.DomUtil.create('div', 'custom-scale');
        scaleDiv.style.position = 'absolute';
        scaleDiv.style.bottom = '8px';
        scaleDiv.style.right = '75px';
        scaleDiv.style.background = 'rgba(255,255,255,0.95)';
        scaleDiv.style.padding = '4px 8px';
        scaleDiv.style.borderRadius = '4px';
        scaleDiv.style.fontSize = '11px';
        scaleDiv.style.fontWeight = '600';
        scaleDiv.style.boxShadow = '0 1px 2px rgba(0,0,0,0.08)';
        scaleDiv.style.zIndex = '1000';
        if(map.getContainer()) map.getContainer().appendChild(scaleDiv);
      }
      function updateScale() {
        const lat = map.getCenter().lat * Math.PI / 180;
        const metersPerPixel = 40075016.686 * Math.cos(lat) / Math.pow(2, map.getZoom() + 8);
        const scale = Math.round(1 / (metersPerPixel / 0.000264583));
        scaleDiv.textContent = '1:' + scale.toLocaleString('tr-TR');
      }
      map.on('zoomend moveend viewreset', updateScale);
      updateScale();
      // nudge zoom position
      const z = document.querySelector('.leaflet-control-zoom');
      if(z){ z.style.right = '10px'; z.style.bottom = '30px'; z.style.transition = 'right 0.2s, bottom 0.2s'; }
    }
    
</script>
<style>
html,body{
  height:100%;
  margin:0;
  font-family:-apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, Arial, sans-serif !important;
  background:#f7f9fb;
  overflow:hidden;
}

/* Sidebar */
#sidebar{
  position:absolute;
  left:0;top:0;
  width:340px;height:100%;
  background:#fff;
  border-right:1px solid #e6eef6;
  box-shadow:2px 0 6px rgba(0,0,0,0.06);
  padding:18px;
  box-sizing:border-box;
  overflow:auto;
  transition:transform .35s ease;
  z-index:1200;
}
#sidebar.closed{transform:translateX(-100%);}
#toggle-btn{
  position:absolute;
  top:20px;left:340px;
  width:28px;height:48px;
  background:#fff;border:1px solid #d0d7df;border-left:none;
  border-radius:0 6px 6px 0;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;z-index:2000;
  box-shadow:0 1px 3px rgba(0,0,0,0.15);
  transition:background 0.2s ease, left .35s ease;
}
#toggle-btn:hover{background:#f3f4f6;}
#toggle-btn span{font-size:14pt;color:#333;user-select:none;}
#sidebar h1{font-weight:700;font-size:12pt;margin:4px 0 8px;}
#sidebar .description{font-weight:400;font-style:italic;font-size:8pt;color:#445;line-height:1.2;margin-bottom:12px;}
#search{width:100%;padding:6px 8px;font-size:8pt;font-style:italic;border:1px solid #d0d7df;border-radius:6px;margin-bottom:12px;box-sizing:border-box;}
.film{margin-bottom:10px;border-bottom:1px solid #f0f4f8;padding-bottom:8px;}
#film-list{margin-bottom:0 !important;padding-bottom:0 !important;}

.film:last-of-type{margin-bottom:0;border-bottom:none;padding-bottom:0;}
.film-title{cursor:pointer;font-weight:500;font-size:11pt;color:#333;margin-bottom:6px;}
.mekan-list{list-style:disc;margin:0 0 0 18px;padding:0;display:none;}
.mekan-list li{font-weight:400;font-size:9pt;margin-bottom:6px;cursor:pointer;color:#333;}
.mekan-list li:hover{text-decoration:underline;}
#map{position:absolute;left:0;top:0;right:0;bottom:0;z-index:1;}
.leaflet-control-zoom{position:absolute !important;bottom: 30px;right:20px;transform: scale(0.75);border-radius:6px;box-shadow:0 1px 2px rgba(0,0,0,0.1);}
.leaflet-popup-content img{max-width:200px;height:auto;border-radius:6px;margin-top:6px;display:block;}
.leaflet-popup-content-wrapper {width:280px !important;max-width:280px !important;}
.leaflet-popup-content { font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, Arial, sans-serif !important; font-weight: 400; }


/* Numeric scale from isi-haritasi.html */
.numeric-scale {
      position:absolute;
      bottom:6px;
      right:8px;
      z-index:1000;
      background:rgba(255,255,255,0.7);
      border-radius:4px;
      padding:2px 6px;
      font-size:11px;
      color:#374151;
      font-family:system-ui, sans-serif;
      pointer-events:none;
    }




/* Fully remove any remaining zoom UI */
.leaflet-control-zoom {
  display: none !important;
  visibility: hidden !important;
}



/* Hide Leaflet attribution text completely */
.leaflet-control-attribution {
  display: none !important;
  visibility: hidden !important;
  opacity: 0 !important;
  height: 0 !important;
  overflow: hidden !important;
  margin: 0 !important;
  padding: 0 !important;
}


/* Se√ßili tab, sayfa ilk y√ºklendiƒüindeki gibi gri g√∂r√ºns√ºn */
.tab-btn.active {
  background: #e8ecf3 !important;
  font-weight: 600 !important;
  border-color: #ccc !important;
}

/* Sekme butonlarƒ± hover efekti ve ge√ßi≈ü animasyonlarƒ± */
.tab-btn {
  transition: background-color 0.25s ease, box-shadow 0.25s ease, transform 0.15s ease;
}
.tab-btn:hover {
  background: #f1f4f9 !important;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  transform: translateY(-1px);
}

/* Sekme i√ßerikleri arasƒ±nda fade ge√ßi≈ü efekti */
.tab-content {
  display: none;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.4s ease, visibility 0.4s ease;
}
.tab-content.active-visible {
  display: block;
  opacity: 1;
  visibility: visible;
  position: relative;
  z-index: 10;
}
.tab-content {
  display: none;
  opacity: 0;
  transition: opacity 0.4s ease;
}
.tab-content.active-visible {
  display: block;
  opacity: 1;
}

/* Sidebar list hover/active styles */
.film-title {
  transition: background-color 0.18s ease, transform 0.12s ease, box-shadow 0.18s ease, color 0.18s ease;
  padding:6px 8px;
  border-radius:6px;
}
.film-title:hover {
  background: #f1f4f9;
  transform: translateY(-2px);
  box-shadow: 0 1px 6px rgba(0,0,0,0.06);
  color: #111;
}
.mekan-list li {
  transition: transform 0.16s ease, color 0.16s ease, padding-left 0.16s ease;
  padding-left:2px;
  border-radius:4px;
}
.mekan-list li:hover {
  transform: translateX(4px);
  color: #111;
  text-decoration: none;
  background: rgba(0,0,0,0.01);
  padding-left:6px;
}
/* Filter info box content */
#filter-info { font-size:12px; color:#0f172a; display:none; }
#filter-info .btn-clear { margin-left:8px; cursor:pointer; color:#2563eb; font-weight:600; text-decoration:underline; background:none;border:none;padding:0; }


/* Selected film title style */
.film-title.selected {
  background: #e8ecf3 !important;
  font-weight: 600;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  border-radius: 6px;
  transform: translateY(-1px);
}


#map-filter-info {
  color: #444455 !important;
}
#map-filter-info .btn-clear:hover {
  background: #f2f4fa !important;
}

#map-filter-info {
  color: #444455 !important;
}

#map-filter-info .btn-clear {
  margin-left: 8px;
  cursor: pointer;
  font-weight: 500;
  background: #f2f3f7; /* gri fon */
  color: #333;
  border: none; /* √ßizgi yok */
  border-radius: 6px;
  padding: 6px 10px;
  transition: background-color 0.25s ease, box-shadow 0.25s ease, transform 0.15s ease;
}

#map-filter-info .btn-clear:hover {
  background: #f2f4fa !important;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  transform: translateY(-1px);
}

/* --- Mobil g√∂r√ºn√ºm d√ºzenlemeleri --- */
@media (max-width: 768px) {
  /* Sekme yazƒ± rengi d√ºzeltme */
  .tab-btn {
    color: #333 !important;
  }

  /* Sidebar geni≈üliƒüini k√º√ß√ºltme */
  #sidebar {
    width: 200px !important;
  }

  /* Toggle butonu yeni geni≈üliƒüe hizala */
  #toggle-btn {
    left: 200px !important;
  }

  /* Sidebar kapalƒ±yken toggle doƒüru konumda kalsƒ±n */
  #sidebar.closed + #toggle-btn {
    left: 0 !important;
  }
}


/* --- Mobil g√∂r√ºn√ºm ek d√ºzenlemeleri (220px sidebar + kutu boyutu/hizasƒ±) --- */
@media (max-width: 768px) {
  /* Sidebar geni≈üliƒüi */
  #sidebar {
    width: 220px !important;
  }

  /* Toggle butonu hizasƒ± */
  #toggle-btn {
    left: 220px !important;
  }

  #sidebar.closed + #toggle-btn {
    left: 0 !important;
  }

  /* "≈ûu anda yalnƒ±zca..." kutusu d√ºzenlemesi */
  #map-filter-info {
    width: 90% !important;
    max-width: 90% !important;
    font-size: 11px !important;
    padding: 4px 8px !important;
    text-align: center !important;
    bottom: 10px !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    border-radius: 8px !important;
  }
}


@media (max-width: 768px) {
  .numeric-scale {
    display: none !important;
  }
}


@media (max-width: 768px) {
  .film-title {
    font-size: 10pt !important;
  }
}


/* üî∏ Bozuk resimleri gizle */
.leaflet-popup-content img[src=""], 
.leaflet-popup-content img:not([src]), 
.leaflet-popup-content img[src*="lh3.googleusercontent.com"],
.leaflet-popup-content img[src*="mymaps.usercontent.google.com"] {
  display: none !important;
}

/* Carousel controls simplified */
.carousel-container {
  margin-top: 4px;
  display: inline-block;
}

.carousel-controls {
  margin-top: 4px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.carousel-buttons {
  display: flex;
  gap: 4px;
}

.carousel-btn {
  border: 1px solid #d0d7df;
  background: #f5f7fa;
  border-radius: 4px;
  padding: 2px 6px;
  font-size: 11px;
  line-height: 1.2;
  cursor: pointer;
  font-family: inherit;
  color: #333;
}

.carousel-btn:hover {
  background: #e8ecf3;
}

.carousel-counter {
  font-size: 10px;
  color: #555;
  padding: 2px 6px;
  border-radius: 4px;
  border: 1px solid #d0d7df;
  background: #f9fafb;
  font-family: inherit;
}


.period-btn {
  display:block;
  width:100%;
  text-align:left;
  padding:6px 8px;
  margin-bottom:6px;
  font-size:11pt;
  border:1px solid #f0f4f8;
  border-radius:6px;
  background:#fff;
  color:#333;
  cursor:pointer;
  transition: background-color 0.18s ease, transform 0.12s ease, box-shadow 0.18s ease;
}
.period-btn:hover {
  background:#f1f4f9;
  transform: translateY(-2px);
  box-shadow:0 1px 6px rgba(0,0,0,0.06);
}
.period-btn.active {
  background:#e8ecf3 !important;
  font-weight:600 !important;
  box-shadow:0 1px 4px rgba(0,0,0,0.08);
  transform: translateY(-1px);
}


/* Sidebar / tab menu thumbnails (same visual scale as popup images) */
.film-menu-image,
.period-menu-image {
  max-width:200px;
  width:100%;
  height:auto;
  border-radius:6px;
  margin:4px 0 6px 0;
  display:block;
}

.period-btn{
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  gap:4px;
}
</style>

<style>
.leaflet-popup-content .carousel-image {
    display: none !important;
}
.leaflet-popup-content .carousel-image.active {
    display: block !important;
}
</style>

</head>
<body>
<aside id="sidebar">
<h1>Ankara‚Äônƒ±n Sinematik Kartografyasƒ±</h1>
<div class="description">
    Bu √ßalƒ±≈üma Ankara √úniversitesi Sosyal Bilimler Enstit√ºs√º Radyo Televizyon ve Sinema Anabilim Dalƒ±'nda 
    Prof. Dr. S. Ruken √ñzt√ºrk danƒ±≈ümanlƒ±ƒüƒ±nda Sezer Ahmet Kƒ±na tarafƒ±ndan y√ºr√ºt√ºlen 
    <i>"Sinemada Kentin D√∂n√º≈ü√ºm√ºn√º Seyretmek: Ankara √ñrneƒüi"</i> ba≈ülƒ±klƒ± doktora tezi kapsamƒ±nda hazƒ±rlanmƒ±≈ütƒ±r.
</div>
<!-- Filter info (appears when a single film is shown) -->
<!-- Tab menu (keeps original look) -->
<div id="tab-menu" style="display:flex;gap:8px;margin-bottom:12px;">
<button class="tab-btn" data-tab="filmler" style="flex:1;padding:6px 4px;border:1px solid #ccc;border-radius:6px;background:#fff;cursor:pointer;">Filmler ve Mek√¢nlar</button>
<button class="tab-btn" data-tab="yogunluk" style="flex:1;padding:6px 4px;border:1px solid #ccc;border-radius:6px;background:#fff;cursor:pointer;">Mek√¢nsal Daƒüƒ±lƒ±m ve Yoƒüunluk</button>
</div>
<!-- Tab contents (IDs kept close to original to avoid breaking code) -->
<div class="tab-content active" id="tab-filmler">
<input aria-label="Haritada ara" id="search" placeholder="Haritada ara"/>
<div id="film-list"></div>
</div>

<div class="tab-content" id="tab-yogunluk">
  <div id="period-buttons" style="display:flex; gap:6px; margin-bottom:10px; flex-wrap:wrap;">
    <button class="period-btn" data-period="1966-1980">1966‚Äì1980: Melodram, Ye≈üil√ßam, Eski Ankara</button>
    <button class="period-btn" data-period="1988-2001">1988‚Äì2001: Neoliberal √áevrim ve √áok Merkezli Kent</button>
    <button class="period-btn" data-period="2010-2022">2010‚Äì2022: Gi≈üe ve Sanat Sarkacƒ±nda Yeniden Yapƒ±lanma</button>
  </div>
  <div id="yogunluk-content"></div>
</div>

</aside>
<div id="toggle-btn"><span>‚óÇ</span></div>
<div id="map">
<div id="map-filter-info" style="display:none;position:absolute;bottom:18px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.85);backdrop-filter:blur(6px);border:1px solid rgba(0,0,0,0.1);border-radius:10px;padding:6px 12px;font-size:13px;color:#111;z-index:1500;box-shadow:0 2px 4px rgba(0,0,0,0.08);"></div>
</div>
<script>
// Helper: clean folder name
function cleanFolderName(folder){
  if(!folder) return "";
  return folder.replace(/[\/|]+/g, '').trim();
}

// Build a safe slug for film title -> menu image filename
function slugifyFilmForImage(name){
  if(!name) return "";
  let s = name.toLowerCase();

  // Turkish character normalization
  const map = {
    'ƒü':'g','ƒû':'g',
    '√º':'u','√ú':'u',
    '≈ü':'s','≈û':'s',
    '√∂':'o','√ñ':'o',
    '√ß':'c','√á':'c',
    'ƒ±':'i','ƒ∞':'i'
  };
  s = s.replace(/[ƒüƒû√º√ú≈ü≈û√∂√ñ√ß√áƒ±ƒ∞]/g, ch => map[ch] || ch);

  // Remove quotes
  s = s.replace(/['"‚Äú‚Äù‚Äò‚Äô]/g, '');

  // Replace non-alphanumeric with space
  s = s.replace(/[^a-z0-9]+/g, ' ');

  // Collapse spaces and join with underscores
  s = s.trim().split(/\s+/).join('_');

  if(!s) return "";
  return s + '.png';
}

// Base URL for sidebar/menu images (relative to site root)

const FILM_MENU_IMAGE_OVERRIDES = [
  { match: 'Meydan K√∂peƒüi', file: 'meydan_kopegi_yilmaz_duru_1966.png' }
];

function getFilmMenuImageUrl(filmTitle){
  if(!filmTitle) return '';
  // Explicit overrides first (e.g. Meydan K√∂peƒüi)
  for (const item of FILM_MENU_IMAGE_OVERRIDES) {
    if (filmTitle.includes(item.match)) {
      return 'images/menu-images/' + item.file;
    }
  }

  // Fallback: slug-based filename
  const slug = slugifyFilmForImage(filmTitle);
  if(!slug) return '';
  return 'images/menu-images/' + slug;
}


// For period buttons in second tab: "1966-1980" -> "1966_1980.png"
function getPeriodMenuImageUrl(periodKey){
  if(!periodKey) return '';
  const base = periodKey.replace(/[^0-9]+/g, '_').replace(/^_+|_+$/g,'');
  if(!base) return '';
  return 'images/menu-images/' + base + '.png';
}


// initialize map (single shared map)
const map = L.map('map', {}).setView([39.93,32.85],11);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  maxZoom: 22, }).addTo(map);
// wire up the earlier scale/setup script
// Numeric scale (from isi-haritasi.html)
const scaleDiv = L.DomUtil.create('div', 'numeric-scale', map.getContainer());
function updateNumericScale() {
  const centerLat = map.getCenter().lat;
  const metersPerPixel = 156543.03392 * Math.cos(centerLat * Math.PI / 180) / Math.pow(2, map.getZoom());
  const scaleDenominator = Math.round(39.37 * metersPerPixel * 96);
  scaleDiv.textContent = '1 : ' + scaleDenominator.toLocaleString('tr-TR');
}
map.on('moveend zoomend', updateNumericScale);
updateNumericScale();


let films = {};
let featureToLayer = new Map();
let allLayers = L.layerGroup().addTo(map);
let allKmzFeatures = [];

// Load kmzs.geojson (original behavior) into the shared layer group
function loadKmzs(onComplete){
  fetch('kmzs.geojson').then(r=>r.json()).then(data=>{
    films = {}; featureToLayer = new Map();
    allLayers.clearLayers();
    allKmzFeatures = [];
    data.features.forEach(f=>{
      // yƒ±l bilgisini properties.folder veya properties.year'den √ßek
      let year = null;
      if (f.properties) {
        if (typeof f.properties.year === 'number') {
          year = f.properties.year;
        } else {
          const folderStr = f.properties.folder || '';
          const ym = folderStr.match(/\b(19[0-9]{2}|20[0-2][0-9])\b/);
          if (ym) year = parseInt(ym[0]);
        }
        if (year) f.properties._year = year;
      }
      allKmzFeatures.push(f);
      const folder = cleanFolderName(f.properties?.folder) || "Bilinmeyen Film";
      const name = f.properties?.name || "(Adsƒ±z Mek√¢n)";
      if(!films[folder]) films[folder]=[];
      films[folder].push(f);

      const geom = f.geometry;
      if(!geom) return;

      const styleProps = f.properties?.style || {};
      const color = styleProps.fillColor || '#e63946';
      let layer = null;
      if(geom.type === 'Point'){
        const coords = [geom.coordinates[1], geom.coordinates[0]];
        const radius = styleProps.radius || 6;
        layer = L.circleMarker(coords, {
          radius,
          color,
          fillColor: styleProps.fillColor || color,
          fillOpacity: ('fillOpacity' in styleProps) ? styleProps.fillOpacity : 1
        });
      } else if(geom.type === 'MultiPoint'){
        const coords = geom.coordinates.map(c => [c[1], c[0]]);
        const group = L.featureGroup(coords.map(c => L.circleMarker(c, {radius: styleProps.radius||6, color, fillColor: styleProps.fillColor||color, fillOpacity: ('fillOpacity' in styleProps)? styleProps.fillOpacity:1})));
        layer = group;
      } else if(geom.type === 'LineString' || geom.type === 'MultiLineString'){
        const coords = (geom.type === 'LineString') ? geom.coordinates.map(c => [c[1], c[0]]) : geom.coordinates.map(line => line.map(c => [c[1], c[0]]));
        layer = (geom.type === 'LineString') ? L.polyline(coords, {color: color, weight: 3, opacity: 0.9}) : L.featureGroup(coords.map(line => L.polyline(line, {color: color, weight:3, opacity:0.9})));
      } else if(geom.type === 'Polygon' || geom.type === 'MultiPolygon'){
        const coords = (geom.type === 'Polygon') ? geom.coordinates.map(ring => ring.map(c => [c[1], c[0]])) : geom.coordinates.map(poly => poly.map(ring => ring.map(c => [c[1], c[0]])));
        layer = (geom.type === 'Polygon') ? L.polygon(coords, {color: color, weight:2, fillColor: color, fillOpacity:0.3}) : L.featureGroup(coords.map(poly => L.polygon(poly, {color: color, weight:2, fillColor: color, fillOpacity:0.3})));
      }

      if(layer){
        
const props = f.properties || {};
let desc = props.description || '';
let rawImgs = (desc.match(/<img[^>]*>/gi) || []);
desc = desc.replace(/<img[^>]*>/gi, '').trim();

// Determine image list
let imgs = [];
if (Array.isArray(props.images)) {
  imgs = props.images.map(src => `<img class='carousel-image' src="${src}" alt="">`);
} else {
  if (props.image) rawImgs.push(`<img class='carousel-image' src="${props.image}" alt="">`);
  imgs = rawImgs;
}

// Popup HTML
let popup = `<div style="font-family:-apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, Arial, sans-serif !important;">`;
popup += `<div style="font-weight:700;font-size:11pt;margin-bottom:4px;">${name}</div>`;
popup += `<div style="font-weight:500;font-size:10pt;margin-bottom:6px;">${folder}</div>`;
if(desc){ popup += `<div style="font-weight:400;font-size:9pt;margin-bottom:8px;">${desc}</div>`; }

// Single or carousel
if (imgs.length === 1) {
  popup += imgs[0].replace("carousel-image", "");
} else if (imgs.length > 1) {
  imgs = imgs.map((im,i)=>im.replace("carousel-image", i===0 ? "carousel-image active" : "carousel-image"));
  popup += `
    <div class="carousel-container">
      ${imgs.join('')}
      <div class="carousel-controls">
        <div class="carousel-buttons">
          <button class="carousel-btn prev" onclick="carouselPrev(this)">‚Äπ</button>
          <button class="carousel-btn next" onclick="carouselNext(this)">‚Ä∫</button>
        </div>
        <div class="carousel-counter">1 / ${imgs.length}</div>
      </div>
    </div>`;
}
popup += `</div>`;
if(layer.getLayers && typeof layer.getLayers === 'function'){
          layer.getLayers().forEach(ch => { if(ch.bindPopup) ch.bindPopup(popup); ch.feature = f; allLayers.addLayer(ch); featureToLayer.set(f, ch); 
    // click ile merkezleme
    if (ch.on) {
      ch.on('click', function(){
        let tc=null;
        if (ch.getLatLng) tc=ch.getLatLng();
        else if (ch.getBounds) tc=ch.getBounds().getCenter();
        if (tc) map.panTo(tc,{animate:true});
      });
    }
    });
        } else {

           if(layer.bindPopup) layer.bindPopup(popup);

// Popup √ßizgisel objelerde merkezde a√ßƒ±lsƒ±n
if (layer instanceof L.Polyline && !(layer instanceof L.Polygon)) {
  layer.off('click'); // varsa eski click eventini kaldƒ±r
  layer.on('click', function (e) {
    const center = layer.getBounds().getCenter();
    map.openPopup(popup, center);
  });
}

          layer.feature = f;
          allLayers.addLayer(layer);
          featureToLayer.set(f, layer);

  
    // click ile merkezleme
    if (layer.on) {
      layer.on('click', function(){
        let tc=null;
        if (layer.getLatLng) tc=layer.getLatLng();
        else if (layer.getBounds) tc=layer.getBounds().getCenter();
        else if (layer.getLayers && typeof layer.getLayers==='function'){
          try{
            const gb=L.latLngBounds([]);
            layer.getLayers().forEach(sub=>{
              if(sub.getLatLng) gb.extend(sub.getLatLng());
              else if(sub.getBounds) gb.extend(sub.getBounds());
            });
            if(gb.isValid && gb.isValid()) tc=gb.getCenter();
          }catch(e){}
        }
        if (tc) map.panTo(tc,{animate:true});
      });
    }
    // üî∏ Marker‚Äôa tƒ±klanƒ±nca merkezle
  if (layer.on) {
    layer.on('click', function() {
      let targetCenter = null;
      if (layer.getLatLng) targetCenter = layer.getLatLng();
      else if (layer.getBounds) targetCenter = layer.getBounds().getCenter();
      else if (layer.getLayers && typeof layer.getLayers === 'function') {
        try {
          const groupBounds = L.latLngBounds([]);
          layer.getLayers().forEach(sub => {
            if (sub.getLatLng) groupBounds.extend(sub.getLatLng());
            else if (sub.getBounds) groupBounds.extend(sub.getBounds());
          });
          if (groupBounds.isValid()) targetCenter = groupBounds.getCenter();
        } catch (err) {}
      }
      if (targetCenter) map.panTo(targetCenter, { animate: true });
    });
  }

        }
      }
    });

    try{
      const b=allLayers.getBounds();
      if(b && b.isValid && b.isValid()) map.fitBounds(b.pad(0.08));
    }catch(e){ map.setView([39.93,32.85],11); }

    // Build film list UI
    const filmList = document.getElementById('film-list');
    filmList.innerHTML = '';
    Object.keys(films)
    .sort((a,b)=>{
      const ya=parseInt((a.match(/\d{4}/)||[0])[0]);
      const yb=parseInt((b.match(/\d{4}/)||[0])[0]);
      return (ya||9999)-(yb||9999);
    })
    .forEach(film=>{
      const div=document.createElement('div');
      div.className='film';
      const title=document.createElement('div');
      title.className='film-title';
      title.textContent=film;

      // Sidebar thumbnail for this film (based on title -> slug)
      const filmImg = document.createElement('img');
      filmImg.className = 'film-menu-image';
      filmImg.alt = film;
      const filmImgUrl = getFilmMenuImageUrl(film);
      if (filmImgUrl) {
        filmImg.src = filmImgUrl;
        filmImg.loading = 'lazy';
        filmImg.onerror = function(){ this.style.display='none'; };
      }

      const ul=document.createElement('ul');
      ul.className='mekan-list';

      films[film].forEach(feat=>{
        const li=document.createElement('li');
        li.textContent=feat.properties.name||'(Adsƒ±z Mekan)';
        li.onclick = (e) => {
  e.stopPropagation();
  const layer = featureToLayer.get(feat);
  if (!layer) return;

  // Her t√ºrl√º katmanda merkez hesaplama
  let targetCenter = null;
  let bounds = L.latLngBounds([]);

  // Eƒüer tek nokta
  if (layer.getLatLng) {
    targetCenter = layer.getLatLng();
  }

  // Eƒüer √ßizgi veya poligon
  else if (layer.getBounds) {
    bounds.extend(layer.getBounds());
  }

  // Eƒüer FeatureGroup (√∂r. MultiLine, MultiPolygon, MultiPoint)
  else if (layer.getLayers && typeof layer.getLayers === "function") {
    layer.getLayers().forEach((sub) => {
      if (sub.getLatLng) bounds.extend(sub.getLatLng());
      else if (sub.getBounds) bounds.extend(sub.getBounds());
    });
  }

  // Eƒüer bounds ge√ßerli ise merkezini al
  if (bounds.isValid && bounds.isValid()) {
    targetCenter = bounds.getCenter();
  }

  // Haritayƒ± merkeze al ve popup‚Äôƒ± a√ß
  if (targetCenter) {
    map.setView(targetCenter, 16, { animate: true });
    setTimeout(() => map.panTo(targetCenter, { animate: true }), 200);
  }

  // Popup tetikle
  if (layer.openPopup) {
    layer.openPopup();
  } else if (layer.getLayers && typeof layer.getLayers === "function") {
    const firstSub = layer.getLayers()[0];
    if (firstSub && firstSub.openPopup) firstSub.openPopup();
  }

  // Mobilde tƒ±klandƒ±ƒüƒ±nda sidebar kapansƒ±n
  if (window.innerWidth <= 768) {
    const sidebar = document.getElementById("sidebar");
    const toggle = document.getElementById("toggle-btn");
    const arrow = toggle.querySelector("span");
    sidebar.classList.add("closed");
    toggle.style.left = "0";
    arrow.textContent = "‚ñ∏";
  }
};
        ul.appendChild(li);
      });

      title.onclick = function(e) {
  // √ñnce diƒüer a√ßƒ±k film alt men√ºlerini kapat
  document.querySelectorAll('.mekan-list').forEach(list => {
    if (list !== ul) list.style.display = 'none';
  });

  // Show only this film's features and fit bounds
  showOnlyFilm(film);

  // Se√ßilen film alt men√ºs√ºn√º a√ß/kapat
  ul.style.display = (ul.style.display === 'none' || ul.style.display === '') ? 'block' : 'none';
};
      div.appendChild(title);
      if (filmImg && filmImg.src) {
        div.appendChild(filmImg);
      }
      div.appendChild(ul);
      filmList.appendChild(div);
    });

    // Search filtering (only in film tab)
    const searchInput = document.getElementById('search');
    searchInput.addEventListener('input',(e)=>{
      const q=e.target.value.trim().toLowerCase();
      document.querySelectorAll('.film').forEach(div=>{
        const title=div.querySelector('.film-title').textContent.toLowerCase();
        const lis=Array.from(div.querySelectorAll('li')).map(li=>li.textContent.toLowerCase());
        const match=title.includes(q)||lis.some(t=>t.includes(q));
        div.style.display=match?'block':'none';
        if(q){
          div.querySelectorAll('li').forEach(li=>{
            const text=li.textContent;
            const re=new RegExp(q,'gi');
            li.innerHTML=text.replace(re, m=>'<mark>'+m+'</mark>');
          });
        } else {

          div.querySelectorAll('li').forEach(li=> li.innerHTML=li.textContent);
        }
      });
    });

    if(onComplete) onComplete();
    // ensure filter info hidden when loading full dataset
    clearFilterInfo();
  }).catch(err=>{
    console.error('kmzs.geojson y√ºkleme hatasƒ±', err);
    if(onComplete) onComplete(err);
  });
}

// D√∂nemsel ƒ±sƒ± haritasƒ± (kmzs.geojson'dan)
function loadHeatmap(periodKey){
  clearFilterInfo();
  allLayers.clearLayers();
  if (!allKmzFeatures.length) return;

  let minYear = 0, maxYear = 9999;
  if (periodKey === '1966-1980') { minYear = 1966; maxYear = 1980; }
  else if (periodKey === '1988-2001') { minYear = 1988; maxYear = 2001; }
  else if (periodKey === '2010-2022') { minYear = 2010; maxYear = 2022; }

  const points = [];

  allKmzFeatures.forEach(f => {
    const props = f.properties || {};
    const year = props._year;
    if (!year || year < minYear || year > maxYear) return;

    const layer = featureToLayer.get(f);
    if (!layer) return;

    const addPointFromLatLng = (latlng) => {
      if (!latlng) return;
      points.push([latlng.lat, latlng.lng, 1.6]);
    };

    if (layer.getLatLng) {
      addPointFromLatLng(layer.getLatLng());
    } else if (layer.getBounds) {
      addPointFromLatLng(layer.getBounds().getCenter());
    } else if (layer.getLayers && typeof layer.getLayers === 'function') {
      try{
        const groupBounds = L.latLngBounds([]);
        layer.getLayers().forEach(sub => {
          if (sub.getLatLng) groupBounds.extend(sub.getLatLng());
          else if (sub.getBounds) groupBounds.extend(sub.getBounds());
        });
        if (groupBounds.isValid && groupBounds.isValid()) {
          addPointFromLatLng(groupBounds.getCenter());
        }
      }catch(e){}
    }
  });

  if (!points.length) {
    console.warn('Se√ßilen d√∂nem i√ßin heatmap noktasƒ± bulunamadƒ±.');
    return;
  }

  L.heatLayer(points, {
    radius: 42,
    blur: 26,
    maxZoom: 19,
    max: 1.0,
    minOpacity: 0.25,
    gradient: {
      0.0: '#000000',
      0.3: '#2b0000',
      0.5: '#660000',
      0.7: '#b30000',
      0.85: '#ff4500',
      1.0: '#ffd000'
    }
  }).addTo(allLayers);

  try{
    const b = allLayers.getBounds();
    if (b && b.isValid && b.isValid()) map.fitBounds(b.pad(0.08));
  }catch(e){}
}

function clearData(){ allLayers.clearLayers(); clearFilterInfo(); }


// --- Helper: pulse visual on a layer (real geometry change for circleMarker or style change for others) ---
function pulseLayer(layer){
  try{
    if(!layer) return;
    // CircleMarker growth
    if(typeof layer.setRadius === 'function' && (layer instanceof L.CircleMarker || layer instanceof L.Circle)){
      var orig = layer.options && (layer.options.radius || layer.getRadius && layer.getRadius()) ? (layer.getRadius ? layer.getRadius() : layer.options.radius) : 6;
      var bigger = Math.round(orig * 2.5);
      layer.setRadius(bigger);
      setTimeout(function(){ try{ layer.setRadius(orig); }catch(e){} }, 1000);
    } else if(typeof layer.setStyle === 'function'){
      // For polylines/polygons, increase weight and bring to front briefly
      var origWeight = (layer.options && layer.options.weight) ? layer.options.weight : 3;
      layer.setStyle({weight: Math.max(2, origWeight*1.8)});
      if(layer.bringToFront) layer.bringToFront();
      setTimeout(function(){ try{ layer.setStyle({weight: origWeight}); }catch(e){} }, 1000);
    }
  }catch(e){ console.error('pulseLayer error', e); }
}

// --- Filter UI helpers ---
function showFilterInfo(filmName){
  var fi = document.getElementById('map-filter-info');
  fi.innerHTML = 'üéûÔ∏è ≈ûu anda yalnƒ±zca <strong>' + filmName + '</strong> filmi g√∂r√ºnt√ºleniyor. '
               + '<button class="btn-clear" onclick="restoreAll()">T√ºm√ºn√º G√∂ster</button>';
  fi.style.display = 'block';
}
function clearFilterInfo(){
  var fi = document.getElementById('map-filter-info');
  if(fi){ fi.style.display='none'; fi.innerHTML=''; }
}
function restoreAll(){
  clearFilterInfo();
  document.querySelectorAll('.film-title').forEach(ft=>ft.classList.remove('selected'));
  loadKmzs();
}
function showOnlyFilm(filmName){
  // Unselect all film titles
  document.querySelectorAll('.film-title').forEach(ft => ft.classList.remove('selected'));
  // Highlight selected film
  document.querySelectorAll('.film-title').forEach(ft => {
    if(ft.textContent.trim() === filmName.trim()) ft.classList.add('selected');
  });
  if(!films || !films[filmName]) return;
  allLayers.clearLayers();
  var bounds = L.latLngBounds([]);
  films[filmName].forEach(function(f){
    var layer = featureToLayer.get(f);
    if(!layer) return;
    if(layer.getLayers && typeof layer.getLayers === 'function'){
      layer.getLayers().forEach(function(ch){
        allLayers.addLayer(ch);
        if(ch.getLatLng) bounds.extend(ch.getLatLng());
        else if(ch.getBounds) bounds.extend(ch.getBounds());
      });
    } else {
      allLayers.addLayer(layer);
      if(layer.getLatLng) bounds.extend(layer.getLatLng());
      else if(layer.getBounds) bounds.extend(layer.getBounds());
    }
  });
  try{
    if(bounds.isValid && bounds.isValid()) map.fitBounds(bounds.pad(0.08));
  }catch(e){ console.error('fitBounds error', e); }
  showFilterInfo(filmName);


}



// D√∂nem filtresi bilgi kutusu (yalnƒ±zca "XXXX‚ÄìYYYY d√∂nemi" kƒ±smƒ± bold)
function showPeriodFilterInfo(periodText){
  var fi = document.getElementById('map-filter-info');
  fi.innerHTML =
    'üó∫Ô∏è ≈ûu anda yalnƒ±zca <strong>' + periodText + ' d√∂nemi</strong> daƒüƒ±lƒ±mƒ± ve yoƒüunluƒüu g√∂r√ºnt√ºleniyor. ' +
    '<button class="btn-clear" onclick="restoreAllPeriods()">T√ºm√ºn√º G√∂ster</button>';
  fi.style.display = 'block';
}

// D√∂nem filtresinde "T√ºm√ºn√º G√∂ster" -> t√ºm d√∂nemleri ƒ±sƒ± haritasƒ± olarak g√∂ster
function restoreAllPeriods(){
  clearFilterInfo();
  document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
  loadFullHeatmap();
}

// T√ºm d√∂nemler i√ßin ƒ±sƒ± haritasƒ± (cavlayan.html ile aynƒ± parametreler)
function loadFullHeatmap(){
  clearFilterInfo();
  allLayers.clearLayers();
  if (!allKmzFeatures.length) return;

  const points = [];

  allKmzFeatures.forEach(f => {
    const layer = featureToLayer.get(f);
    if (!layer) return;

    const addPointFromLatLng = (latlng) => {
      if (!latlng) return;
      points.push([latlng.lat, latlng.lng, 1.6]);
    };

    if (layer.getLatLng) {
      addPointFromLatLng(layer.getLatLng());
    } else if (layer.getBounds) {
      addPointFromLatLng(layer.getBounds().getCenter());
    } else if (layer.getLayers && typeof layer.getLayers === 'function') {
      try{
        const groupBounds = L.latLngBounds([]);
        layer.getLayers().forEach(sub => {
          if (sub.getLatLng) groupBounds.extend(sub.getLatLng());
          else if (sub.getBounds) groupBounds.extend(sub.getBounds());
        });
        if (groupBounds.isValid && groupBounds.isValid()) {
          addPointFromLatLng(groupBounds.getCenter());
        }
      }catch(e){}
    }
  });

  if (!points.length) {
    console.warn('T√ºm d√∂nemler i√ßin heatmap noktasƒ± bulunamadƒ±.');
    return;
  }

  L.heatLayer(points, {
    radius: 42,
    blur: 26,
    maxZoom: 19,
    max: 1.0,
    minOpacity: 0.25,
    gradient: {
      0.0: '#000000',
      0.3: '#2b0000',
      0.5: '#660000',
      0.7: '#b30000',
      0.85: '#ff4500',
      1.0: '#ffd000'
    }
  }).addTo(allLayers);

  try{
    const b = allLayers.getBounds();
    if (b && b.isValid && b.isValid()) map.fitBounds(b.pad(0.08));
  }catch(e){}
}

// Sidebar toggle
const sidebar=document.getElementById('sidebar');
const toggle=document.getElementById('toggle-btn');
const arrow=toggle.querySelector('span');
toggle.addEventListener('click',()=>{
  sidebar.classList.toggle('closed');
  if(sidebar.classList.contains('closed')){
    toggle.style.left='0';
    arrow.textContent='‚ñ∏';
  } else {

    toggle.style.left='340px';
    arrow.textContent='‚óÇ';
  }
  map.invalidateSize();
});

// Tab switching (preserve original styles and film UI)
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', () => {
    // fade ge√ßi≈üi y√∂net
    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active-visible'));

    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    // show/hide tab-content blocks
    document.getElementById('tab-filmler').classList.toggle('active-visible', btn.dataset.tab === 'filmler');
    document.getElementById('tab-yogunluk').classList.toggle('active-visible', btn.dataset.tab === 'yogunluk');

    if(btn.dataset.tab === 'filmler'){
      document.getElementById('tab-filmler').classList.add('active-visible');

      // load kmzs and show film list/search
      document.getElementById('search').style.display = 'block';
      document.getElementById('film-list').style.display = 'block';
      loadKmzs();
// ensure default tab visually active
document.getElementById('tab-filmler').classList.add('active-visible');
document.getElementById('tab-filmler').classList.add('active-visible');
document.querySelector('.tab-btn[data-tab="filmler"]').classList.add('active');
    } else if(btn.dataset.tab === 'yogunluk'){
      document.getElementById('tab-yogunluk').classList.add('active-visible');

      // hide film UI
      document.getElementById('search').style.display = 'none';
      document.getElementById('film-list').style.display = 'none';

      // varsayƒ±lan: t√ºm d√∂nemlerin yoƒüunluƒüunu g√∂ster
      document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
      loadFullHeatmap();
      clearFilterInfo();

      // auto zoom + offset center (sidebar a√ßƒ±k kalƒ±yor)
      setTimeout(() => {
        const newCenter = [39.92634964804977, 32.85766936751545];
        map.setView(newCenter, 13, { animate: true });
      }, 300);
    } else {

      // Duygu: clear layers and hide film UI
      document.getElementById('search').style.display = 'none';
      document.getElementById('film-list').style.display = 'none';
      clearData();
    }
  });
});

// D√∂nem butonlarƒ±: tƒ±klanƒ±nca g√∂r√ºn√ºm√º ve ƒ±sƒ± haritasƒ±nƒ± g√ºncelle
document.querySelectorAll('.period-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const periodKey = btn.getAttribute('data-period');
    // sadece ikinci tab aktifken haritayƒ± g√ºncelle
    const yogunlukTabBtn = document.querySelector('.tab-btn[data-tab="yogunluk"]');
    if (yogunlukTabBtn && yogunlukTabBtn.classList.contains('active')) {
      loadHeatmap(periodKey);

      const periodText = btn.textContent.split(':')[0].trim();
      showPeriodFilterInfo(periodText);
    }
  });
});

// YOGUNLUK sekmesi i√ßin: d√∂nem butonlarƒ±nƒ±n altƒ±na k√º√ß√ºk √∂nizleme g√∂rseli ekle
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.period-btn').forEach(btn => {
    const periodKey = btn.getAttribute('data-period');
    const imgUrl = getPeriodMenuImageUrl(periodKey);
    if (!imgUrl) return;
    const img = document.createElement('img');
    img.className = 'period-menu-image';
    img.alt = btn.textContent.trim();
    img.src = imgUrl;
    img.loading = 'lazy';
    img.onerror = function(){ this.style.display='none'; };
    btn.appendChild(img);
  });
});


// Initial load: populate film tab exactly like original
loadKmzs();
// ensure default tab visually active
document.getElementById('tab-filmler').classList.add('active-visible');
document.getElementById('tab-filmler').classList.add('active-visible');
document.querySelector('.tab-btn[data-tab="filmler"]').classList.add('active');

</script>

<script>
function carouselNext(btn){
  const container = btn.closest('.carousel-container');
  if (!container) return;
  const imgs = container.querySelectorAll('.carousel-image');
  const counter = container.querySelector('.carousel-counter');
  if (!imgs.length) return;
  let i = [...imgs].findIndex(im => im.classList.contains('active'));
  if (i === -1) i = 0;

  imgs[i].classList.remove('active');
  const newIndex = (i + 1) % imgs.length;
  imgs[newIndex].classList.add('active');

  if (counter) {
    counter.textContent = (newIndex + 1) + ' / ' + imgs.length;
  }
}
function carouselPrev(btn){
  const container = btn.closest('.carousel-container');
  if (!container) return;
  const imgs = container.querySelectorAll('.carousel-image');
  const counter = container.querySelector('.carousel-counter');
  if (!imgs.length) return;
  let i = [...imgs].findIndex(im => im.classList.contains('active'));
  if (i === -1) i = 0;

  imgs[i].classList.remove('active');
  const newIndex = (i - 1 + imgs.length) % imgs.length;
  imgs[newIndex].classList.add('active');

  if (counter) {
    counter.textContent = (newIndex + 1) + ' / ' + imgs.length;
  }
}
</script>

</body>
</html>